---
import { getEntry, getCollection } from "astro:content";
import Layout from "../../layouts/MainLayout.astro";
import TagList from "../../components/TagList.astro";
import { getRelatedPosts } from "../../utils/tag-utils";

const { slug } = Astro.params;

if (!slug) {
  throw new Error("Blog post not found");
}

const post = await getEntry("blog", slug);

if (!post) {
  throw new Error("Blog post not found");
}

// Get all blog posts to find related ones
const allPosts = await getCollection("blog");
const relatedPosts = getRelatedPosts(post, allPosts, 3);

const { title, excerpt, date, tags = [], cover_image } = post.data;

// Debug: Log the cover_image value
console.log("Cover image:", cover_image);
console.log("Post data:", post.data);

const { Content } = await post.render();
---

<Layout title={`${title} | Nick Taylor`}>
  <main class="mt-4 md:mt-8 lg:mt-16">
    <article class="max-w-3xl grid gap-8">
      <header>
        {
          cover_image ? (
            <img
              src={cover_image}
              alt=""
              class="w-full max-w-2xl rounded shadow my-4"
            />
          ) : null
        }
        <h1
          class="text-4xl font-extrabold leading-tight mb-2 relative inline-block"
        >
          {title}
        </h1>
        {excerpt && <p class="text-xl text-gray-600 mt-2">{excerpt}</p>}
        <div class="text-lg text-gray-600 mt-4 relative inline-block">
          <time datetime={date}>
            {
              new Date(date).toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            }
          </time>
        </div>
      </header>

      <div class="prose max-w-none">
        <Content />
      </div>

      <div class="flex flex-wrap gap-2 mt-4">
        <TagList tags={tags} />
      </div>

      {
        relatedPosts.length > 0 && (
          <section class="mt-12 border-t pt-6">
            <h2 class="text-2xl font-bold mb-4">Related Posts</h2>
            <ul class="grid gap-4">
              {relatedPosts.map((relatedPost) => {
                const relatedSlug = relatedPost.id
                  .replace(/^blog\//, "")
                  .replace(/\.md$/, "");
                return (
                  <li>
                    <a href={`/blog/${relatedSlug}`} class="hover:underline">
                      <article>
                        <h3 class="font-medium">{relatedPost.data.title}</h3>
                        {relatedPost.data.excerpt && (
                          <p class="text-sm text-gray-600 mt-1">
                            {relatedPost.data.excerpt}
                          </p>
                        )}
                        <div class="text-sm text-gray-600 mt-1">
                          <time datetime={relatedPost.data.date}>
                            {new Date(relatedPost.data.date).toLocaleDateString(
                              "en-US",
                              {
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                              },
                            )}
                          </time>
                        </div>
                        <div class="mt-1">
                          <TagList
                            tags={relatedPost.data.tags || []}
                            limit={3}
                          />
                        </div>
                      </article>
                    </a>
                  </li>
                );
              })}
            </ul>
          </section>
        )
      }
    </article>
  </main>
</Layout>
